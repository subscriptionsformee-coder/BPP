<app-loader [isLoading]="isLoading"></app-loader>

<div class="modern-step-details-page">
  <!-- Header -->
  <div class="step-details-header modern-card">
    <div class="header-actions">
      <button class="action-btn-modern back-btn" title="Back" (click)="navigateBack()">
        <mat-icon>arrow_back</mat-icon>
        <span>Back</span>
      </button>
      <button class="action-btn-modern refresh-btn" title="Refresh" (click)="onRefresh()">
        <mat-icon>refresh</mat-icon>
        <span>Refresh</span>
      </button>
    </div>
  </div>

  <!-- Stepper -->
  <div class="stepper-section">
    <app-stepper [workFlow]="workFlow" [loading]="isLoading"></app-stepper>
  </div>

  <!-- Step Details Table -->
  <div class="step-details-content modern-card">
    <div class="content-header">
      <h3>Process Step Details</h3>
      <p>Detailed breakdown of each step in the automation process</p>
    </div>

    <div class="table-container">
      <div class="modern-table-wrapper">
        <table class="modern-table">
          <thead>
            <tr>
              <th><div class="th-content"><mat-icon>label</mat-icon> Step Name</div></th>
              <th><div class="th-content"><mat-icon>schedule</mat-icon> Process Time</div></th>
              <th><div class="th-content"><mat-icon>info</mat-icon> Status</div></th>
              <th><div class="th-content"><mat-icon>comment</mat-icon> Comments</div></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let step of steps; let i = index" class="table-row" [class.even]="i % 2 === 0">
              <td class="step-name-cell">
                <div class="step-info">
                  <div class="step-number">{{ i + 1 }}</div>
                  <span>{{ step.step_name || 'No step name' }}</span>
                </div>
              </td>
              <td class="time-cell">
                <div class="time-info">
                  <mat-icon>access_time</mat-icon>
                  <span>{{
                    step.process_time
                      ? (step.process_time | formatDateTime : "MM-dd-yyyy, HH:mm:ss")
                      : "Not processed"
                  }}</span>
                </div>
              </td>
              <td class="status-cell">
                <div class="modern-status-badge" [ngClass]="getStatusBadge(step.step_status).statusClass">
                  <mat-icon>{{ getStatusIcon(step.step_status) }}</mat-icon>
                  <span>{{ getStatusBadge(step.step_status).statusText }}</span>
                </div>
              </td>
              <td class="comments-cell">
                <div class="comment-content">
                  <ng-container *ngIf="step.step_name?.toLowerCase() === 'document analysis'; else normalComment">
                    <span>{{ step.comments || 'No comments available' }}</span>
                    <button
                      *ngIf="step.step_status?.toLowerCase() === 'completed'"
                      class="download-btn view-docs-btn"
                      title="View Docs"
                      (click)="openDocumentAnalysis(step)">
                      <mat-icon>visibility</mat-icon>
                      View Docs
                    </button>
                  </ng-container>
                  <ng-template #normalComment>
                    <span>{{ step.comments || 'No comments available' }}</span>
                  </ng-template>
                </div>
              </td>
            </tr>

            <tr *ngIf="steps.length === 0" class="empty-row">
              <td colspan="4">
                <div class="empty-state">
                  <mat-icon>info_outline</mat-icon>
                  <span>No step details available</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ==================== MINIMIZED CHAT WIDGET ==================== -->
  <div class="minimized-chat-widget" *ngIf="showDocumentPopup && isMinimized" (click)="restoreWindow()">
    <div class="widget-header">
      <mat-icon>psychology</mat-icon>
      <span>Automation Assistant</span>
    </div>
    <button class="widget-close" (click)="closeDocumentPopup(); $event.stopPropagation()" title="Close">
      <mat-icon>close</mat-icon>
    </button>
    <button class="widget-expand" (click)="restoreWindow(); $event.stopPropagation()" title="Expand">
      <mat-icon>open_in_full</mat-icon>
    </button>
  </div>

  <!-- ==================== DRAGGABLE FLOATING WINDOW ==================== -->
  <div class="draggable-window-container" *ngIf="showDocumentPopup && !isMinimized">
    <div class="draggable-window"
         [ngClass]="{ 'maximized': isMaximized }"
         [style.left.px]="windowPosition.x"
         [style.top.px]="windowPosition.y"
         [style.width.px]="windowSize.width"
         [style.height.px]="windowSize.height">
      
      <!-- Window Header (Draggable) -->
      <div class="draggable-header" 
           (mousedown)="startDragging($event)"
           (dblclick)="toggleMaximize()">
        <div class="header-left">
          <mat-icon class="window-icon">dashboard</mat-icon>
          <h3>Automation</h3>
        </div>
        <div class="header-controls">
          <button class="header-btn minimize" (click)="minimizeWindow()" title="Minimize">
            <mat-icon>minimize</mat-icon>
          </button>
          <button class="header-btn maximize" (click)="toggleMaximize()" [title]="isMaximized ? 'Restore' : 'Maximize'">
            <mat-icon>{{ isMaximized ? 'fullscreen_exit' : 'crop_square' }}</mat-icon>
          </button>
          <button class="header-btn close" (click)="closeDocumentPopup()" title="Close">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>

      <!-- Window Body (3-Column Layout) -->
      <div class="draggable-body">
        
        <!-- LEFT PANEL: Configuration (Compact) -->
        <div class="config-panel">
          <div class="panel-header">
            <mat-icon>settings</mat-icon>
            <h4>Configuration</h4>
          </div>

          <div class="config-content">
            <!-- LOB -->
            <div class="config-field">
              <label>Line of Business</label>
              <select [(ngModel)]="modelDestinationLob">
                <option value="">Select LOB</option>
                <option *ngFor="let lob of lobOptions" [value]="lob">{{ lob }}</option>
              </select>
            </div>

            <!-- Base Document -->
            <div class="config-field">
              <label>Base Document</label>
              <select [(ngModel)]="selectedSourceDocument">
                <option value="">Select Base Document</option>
                <option *ngFor="let doc of availableDocuments" [value]="doc">{{ doc }}</option>
              </select>
            </div>

            <!-- Comparing Documents -->
            <div class="config-field">
              <div class="field-header">
                <label>Comparing Documents</label>
                <button class="add-btn" (click)="addTargetDocument()" title="Add Document">
                  <mat-icon>add_circle</mat-icon>
                </button>
              </div>

              <div class="comparing-list">
                <div class="comparing-item" *ngFor="let target of selectedTargetDocuments; let i = index">
                  <select [(ngModel)]="selectedTargetDocuments[i]">
                    <option value="">Select Document</option>
                    <option *ngFor="let doc of availableDocuments" [value]="doc">{{ doc }}</option>
                  </select>
                  <button class="remove-btn" (click)="removeTargetDocument(i)" title="Remove">
                    <mat-icon>remove_circle</mat-icon>
                  </button>
                </div>
                <div class="empty-comparing" *ngIf="selectedTargetDocuments.length === 0">
                  <mat-icon>info</mat-icon>
                  <span>Click + to add documents</span>
                </div>
              </div>
            </div>

            <!-- Save Button -->
            <button class="save-btn" (click)="saveDocumentChanges()">
              <mat-icon>save</mat-icon>
              Save Configuration
            </button>
          </div>
        </div>

        <!-- MIDDLE PANEL: Chat Assistant -->
        <div class="chat-panel">
          <div class="panel-header">
            <mat-icon>smart_toy</mat-icon>
            <h4>Document Assistant</h4>
          </div>

          <div class="chat-messages-area">
            <div *ngFor="let message of chatMessages; trackBy: trackByMessageId"
                 class="chat-msg"
                 [ngClass]="message.sender">
              
              <div class="msg-avatar" *ngIf="message.sender === 'bot'">
                <mat-icon>psychology</mat-icon>
              </div>

              <div class="msg-content">
                <div class="msg-bubble">{{ message.text }}</div>
                <div class="msg-time">{{ message.timestamp | date:'short' }}</div>
              </div>
<!-- 
              <div class="msg-avatar" *ngIf="message.sender === 'user'">
                <mat-icon>person</mat-icon>
              </div> -->
            </div>

            <!-- Typing Indicator -->
            <div class="chat-msg bot" *ngIf="isSendingMessage">
              <div class="msg-avatar">
                <mat-icon>psychology</mat-icon>
              </div>
              <div class="msg-content">
                <div class="msg-bubble typing">
                  <span></span><span></span><span></span>
                </div>
              </div>
            </div>

            <!-- Empty State -->
            <div class="chat-empty" *ngIf="chatMessages.length === 0 && !isSendingMessage">
              <mat-icon>chat_bubble_outline</mat-icon>
              <p>Start a conversation</p>
            </div>
          </div>

          <div class="chat-input-area">
            <input 
              type="text"
              placeholder="Ask about documents or analysis..."
              [(ngModel)]="chatInput"
              (keydown.enter)="sendChatMessage()"
              [disabled]="isSendingMessage"
            />
            <button (click)="sendChatMessage()" 
                    [disabled]="!chatInput.trim() || isSendingMessage"
                    title="Send">
              <mat-icon>send</mat-icon>
            </button>
          </div>
        </div>

        <!-- RIGHT PANEL: Documents Browser (Collapsible) -->
        <div class="docs-panel" [ngClass]="{ 'collapsed': isDocsPanelCollapsed }">
          <div class="panel-header">
            <div class="header-title">
              <mat-icon>folder_open</mat-icon>
              <h4>Documents ({{ availableDocuments.length }})</h4>
            </div>
            <button class="collapse-btn" (click)="toggleDocsPanel()" [title]="isDocsPanelCollapsed ? 'Expand' : 'Collapse'">
              <mat-icon>{{ isDocsPanelCollapsed ? 'chevron_left' : 'chevron_right' }}</mat-icon>
            </button>
          </div>

          <div class="docs-list" *ngIf="!isDocsPanelCollapsed">
            <div class="doc-item" 
                 *ngFor="let doc of availableDocuments; trackBy: trackByIndex"
                 (click)="viewDocument(doc)">
              <div class="doc-icon">
                <mat-icon>{{ getDocumentIcon(doc) }}</mat-icon>
              </div>
              <div class="doc-info">
                <span class="doc-name" [title]="doc">{{ doc }}</span>
                <button class="view-btn" (click)="viewDocument(doc); $event.stopPropagation()" title="View">
                  <mat-icon>visibility</mat-icon>
                </button>
              </div>
            </div>

            <div class="docs-empty" *ngIf="availableDocuments.length === 0">
              <mat-icon>folder_off</mat-icon>
              <p>No documents available</p>
            </div>
          </div>

          <!-- Collapsed State -->
          <div class="docs-collapsed-hint" *ngIf="isDocsPanelCollapsed">
            <mat-icon>folder_open</mat-icon>
            <span>{{ availableDocuments.length }}</span>
          </div>
        </div>

      </div>

      <!-- Resize Handle -->
      <div class="resize-handle"
           *ngIf="!isMaximized"
           (mousedown)="startResizing($event)"></div>
    </div>
  </div>

  <!-- ==================== PDF VIEWER MODAL ==================== -->
  <div class="document-viewer-overlay" *ngIf="showDocumentViewer" (click)="closeDocumentViewer()">
    <div class="document-viewer-modal" (click)="$event.stopPropagation()">
      <div class="viewer-header">
        <div class="viewer-title">
          <mat-icon>description</mat-icon>
          <h3>{{ selectedDocumentForView }}</h3>
        </div>
        <button class="close-viewer-btn" (click)="closeDocumentViewer()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="viewer-body">
        <div class="viewer-loading" *ngIf="isLoadingDocument">
          <mat-icon class="spinning">refresh</mat-icon>
          <p>Loading document...</p>
        </div>

        <iframe 
          *ngIf="!isLoadingDocument && documentViewerUrl"
          [src]="documentViewerUrl"
          class="document-iframe"
          frameborder="0">
        </iframe>

        <div class="viewer-error" *ngIf="!isLoadingDocument && !documentViewerUrl">
          <mat-icon>error_outline</mat-icon>
          <p>Unable to load document</p>
        </div>
      </div>
    </div>
  </div>
</div>